<div class="container mt-4">
  <div class="card border-primary mb-4">
    <div class="card-header bg-primary text-white">
      <h2 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Resultado Final</h2>
    </div>
    <div class="card-body">
      <div class="row gy-3">
        <div class="col-md-6">
          <p><strong><i class="fas fa-user me-2"></i>Nome:</strong> {{resultado.nome}}</p>
          <p><strong><i class="fas fa-calendar-alt me-2"></i>Data:</strong> {{formatDate resultado.dataHora}}</p>
        </div>
        <div class="col-md-6">
          <p class="mb-2"><strong><i class="fas fa-star me-2"></i>Pontuação:</strong>
            <span class="badge bg-{{getScoreClass resultado.pontuacao resultado.totalPerguntas}}">
              {{resultado.pontuacao}}/{{resultado.totalPerguntas}}
            </span>
          </p>
          <div class="progress" style="height: 25px;">
            <div
              class="progress-bar progress-bar-striped bg-{{getScoreClass resultado.pontuacao resultado.totalPerguntas}}"
              role="progressbar" style="width: {{calculatePercentage resultado.pontuacao resultado.totalPerguntas}}%"
              aria-valuenow="{{resultado.pontuacao}}" aria-valuemin="0" aria-valuemax="{{resultado.totalPerguntas}}">
              {{calculatePercentage resultado.pontuacao resultado.totalPerguntas}}%
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{!-- Sucesso / erros --}}
  {{#if (eq resultado.pontuacao resultado.totalPerguntas)}}
  <div class="alert alert-success d-flex align-items-center">
    <i class="fas fa-trophy fa-2x me-3"></i>
    <div>
      <h4 class="alert-heading">Excelente!</h4>
      <p class="mb-0">Você acertou todas as questões! Parabéns!</p>
    </div>
  </div>
  {{else if resultado.respostasErradas}}
  {{#if resultado.respostasErradas.length}}
  <div class="card border-warning mb-4">
    <div class="card-header bg-warning text-dark">
      <h4 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Questões Incorretas
        ({{resultado.respostasErradas.length}})</h4>
    </div>
    <div class="card-body p-0">
      <div class="list-group list-group-flush">
        {{#each resultado.respostasErradas}}
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="mb-1"><span class="badge bg-secondary me-2">{{increment @index}}</span> {{pergunta}}</h5>
              <p class="mb-1"><small class="text-muted"><i class="fas fa-book me-1"></i>{{disciplina}}</small></p>
            </div>
            <span class="badge bg-danger">Errada</span>
          </div>
          <div class="mt-3">
            <div class="alert alert-danger py-2 mb-2">
              <i class="fas fa-times-circle me-2"></i><strong>Sua resposta:</strong> {{respostaErrada}}
            </div>
            <div class="alert alert-success py-2 mb-0">
              <i class="fas fa-check-circle me-2"></i><strong>Resposta correta:</strong> {{respostaCorreta}}
            </div>
          </div>
        </div>
        {{/each}}
      </div>
    </div>
  </div>
  {{else}}
  <div class="alert alert-info d-flex align-items-center">
    <i class="fas fa-info-circle fa-2x me-3"></i>
    <div>
      <h4 class="alert-heading">Atenção</h4>
      <p class="mb-0">Nenhuma resposta correta foi registrada.</p>
    </div>
  </div>
  {{/if}}
  {{else}}
  <div class="alert alert-info d-flex align-items-center">
    <i class="fas fa-info-circle fa-2x me-3"></i>
    <div>
      <h4 class="alert-heading">Atenção</h4>
      <p class="mb-0">Nenhuma resposta correta foi registrada.</p>
    </div>
  </div>
  {{/if}}

  {{#if (gt (size resultado.acertosPorDisciplina) 0)}}
  <div class="card border-info mt-4">
    <div class="card-header bg-info text-white">
      <h4 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Desempenho por Disciplina</h4>
    </div>
    <div class="card-body position-relative" style="height: 400px;">
      <canvas id="graficoDisciplinas"></canvas>
    </div>
  </div>

  <!-- Chart.js (caso não esteja no layout principal) -->

  <!-- Inclua o Chart.js se ainda não estiver no layout principal -->


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>




  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let chart;
      let ultimaPontuacao = null;

      async function atualizarGrafico() {
        try {
          const res = await fetch("/api/resultados");
          const resultados = await res.json();

          // Pegue a última tentativa do usuário
          const ultimo = resultados[resultados.length - 1];
          if (!ultimo) return;

          // Só atualiza se a pontuação mudou
          if (ultimaPontuacao !== ultimo.pontuacao) {
            ultimaPontuacao = ultimo.pontuacao;

            const acertosPorDisciplina = ultimo.acertosPorDisciplina || {};
            const labels = Object.keys(acertosPorDisciplina);
            const data = Object.values(acertosPorDisciplina);

            const ctx = document.getElementById('graficoDisciplinas').getContext('2d');

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels,
                datasets: [{
                  label: 'Acertos por Disciplina',
                  data,
                  backgroundColor: 'rgba(13,110,253,.25)',
                  borderColor: 'rgba(13,110,253,1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: 'Acertos' } },
                  x: { title: { display: true, text: 'Disciplina' } }
                }
              }
            });
          }
        } catch (err) {
          console.error("Erro ao atualizar gráfico:", err);
        }
      }

      // Checa a cada 5s
      atualizarGrafico();
      setInterval(atualizarGrafico, 5000);
    });
  </script>





  {{/if}}

  <div class="text-center my-4">
    <a href="/" class="btn btn-primary btn-lg px-5 me-3">
      <i class="fas fa-home me-2"></i>Voltar ao Início
    </a>
    <button onclick="window.print()" class="btn btn-outline-secondary btn-lg px-5">
      <i class="fas fa-print me-2"></i>Imprimir Resultado
    </button>
  </div>
</div>